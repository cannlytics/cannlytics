<!doctype html>
<html>
<!--
  Algorithm Farm Page | Cannlytics Website
  Copyright (c) 2021-2022 Cannlytics

  Authors: Keegan Skeate <https://github.com/keeganskeate>
  Created: 6/25/2022
  Updated: 6/26/2022
  License: MIT License <https://github.com/cannlytics/cannlytics/blob/main/LICENSE>
-->
{% extends "website/index.html" %}
{% load static icon %}
{% block title %}The Algorithm Farm | Cannlytics{% endblock %}
{% block material %}

<!-- Banner -->
<!-- TODO: Add picture of California countryside! -->
{% include "website/components/heros/hero_banner.html" with
  title=''
  description='Welcome to The Algorithm Farm, find a nice, large plot for yourself and grow your algorithms with the best of them!'
  image_url='https://firebasestorage.googleapis.com/v0/b/cannlytics.appspot.com/o/public%2Fimages%2Flogos%2Fcannlytics_algorithm_farm.png?alt=media&token=5a708351-a5e3-4437-b6bb-19bd6ec339f6'
  image_size="200px"
  only
%}

<!-- Breadcrumbs -->
<section class="container">
  <div class="d-flex mt-4">
    <nav
      style="--bs-breadcrumb-divider: '>';"
      aria-label="breadcrumb"
    >
      <ol class="breadcrumb bg-transparent p-0 mb-0">
        <li class="breadcrumb-item fs-6 lh-sm">
          <a
            class="text-dark serif action"
            href="{% url 'page' page='data' %}"
          >
            Data
          </a>
        </li>
        <li class="breadcrumb-item fs-6 lh-sm">
          <a
            class="text-dark serif action"
            href="{% url 'section' page='data' section='market' %}"
          >
            The Algorithm Farm
          </a>
        </li>
      </ol>
      <div>
    </div>
    </nav>
  </div>
</section>

<!-- The Algorithm Farm -->
<section class="container mb-5 markdown">

  <!-- Introduction -->
  <div class="col markdown">
    {{ algorithm_market|safe }}
  </div>

  <!-- Warning -->
  <div class="alert alert-warning d-flex justify-content-between mt-3 mb-0" role="alert">
    <div class="row d-flex align-items-center">
      <div class="col-1 me-3" style="max-width:42px;">{% icon 'alert-triangle' height="32" width="32"%}</div>
      <div class="col-10 ps-0"><small class="serif">
        The Algorithm Farm is still in test-mode. You are welcome to test out the functionality,
        but <b class="serif">do not</b> use actual money and <b class="serif">do not</b> expect actual results.
        You can get <a href="https://www.rinkeby.io/#faucet" target="_blank" class="serif">test currency</a> to
        begin to explore the market.
        </small>
      </div>
    </div>
  </div>

  <!-- Publish an Algorithm -->
  <div class="card mt-4">
    <div class="card-header">
      <h4 class="text-dark serif my-0">
        Publish an Algorithm
      </h4>
    </div>
    <div class="card-body bg-transparent text-dark">

      <!-- Instructions-->
      <p class="mt-0 lh-md mb-lg-4" style="max-width:460px;">
        <small>
          Publish an algorithm that can compute with blockchain data as a service.
          If your algorithm depends on data that you own,
          then you can publish your data on the
          <a class="fw-bold text-dark serif background-hover" href="{% url "section" page="data" section="market" %}"><small>Cannabis Data Market</small></a>
          and allow your algorithm to use your data asset(s).
          <button
            type="button"
            class="btn btn-tooltip-help p-0 mb-1 ms-1"
            style="border-color:transparent !important;"
            data-bs-toggle="tooltip"
            data-bs-html="true"
            title='Please refer to the <a href="https://github.com/cannlytics/cannlytics">documentation</a> to review the source code and get all of the information on how the market operates.'
          >
            {% icon 'help-circle' width="18px" height="18px" class="text-dark" %}
          </button>
        </small>
        </p>


      <div class="row">

        <!-- First Column -->
        <div class="col col-md-4">

          <!-- Algorithm Detail Form -->
          <form id="user-form">

            <!-- Algorithm Name -->
            <div class="mt-3">
              <label
                for="input-algorithm_name"
                class="form-label form-label-sm"
              >
                <small class="serif">Algorithm Name</small>
              </label>
              <input
                id="input-algorithm_name"
                class="form-control form-control-sm serif"
                name="algorithm_name"
                spellcheck="false"
                type="text"
              >
            </div>

            <!-- Price -->
            <div class="mt-3">
              <label
                for="input-algorithm_price"
                class="form-label form-label-sm"
              >
                <small class="serif">Price per Run</small>
              </label>
              <div class="row">
                <div class="col-6 pe-1">
                  <input
                    id="input-algorithm_price"
                    class="form-control form-control-sm serif text-end"
                    name="algorithm_price"
                    spellcheck="false"
                    type="number"
                    value="0.00"
                  >
                </div>
                <div class="col-6 ps-1">
                  <select
                    id="input-currency"
                    class="form-select form-select-sm serif col col-4"
                    aria-label="Currency"
                    name="currency"
                  >
                    <option selected>USD ($)</option>
                  </select>
                </div>
              </div>
            </div>

            <!-- Programming Language -->
            <div class="mt-3">
              <label
                for="input-programming_language"
                class="form-label form-label-sm"
              >
                <small class="serif">Programming Language</small>
              </label>
              <select
                id="input-programming_language"
                class="form-select form-select-sm serif"
                aria-label="Programming Language select"
                name="programming_language"
              >
                <option selected>Python 3.9</option>
              </select>
            </div>

            <!-- Entry Point -->
            <div class="mt-3">
              <label
                for="input-entry_point"
                class="form-label form-label-sm"
              >
                <small class="serif">Entry Point</small>
              </label>
              <input
                id="input-entry_point"
                class="form-control form-control-sm serif"
                name="entry_point"
                type="text"
                spellcheck="false"
                value="main"
              >
            </div>

            <!-- License -->
            <div class="mt-3">
              <label
                for="input-license"
                class="form-label form-label-sm"
              >
                <small class="serif">License</small>
              </label>
              <select
                id="input-label"
                class="form-select form-select-sm serif"
                aria-label="Algorithm license."
                name="license"
              >
                <option selected>CC0: PublicDomain</option>
              </select>
            </div>

            <!-- Version? | Description? | Requirements.txt? -->

            <!-- Docker Image -->
            <div class="mt-3">
              <label
                for="input-docker_image"
                class="form-label form-label-sm"
              >
                <small class="serif">Docker Image</small>
                <button
                  type="button"
                  class="btn btn-tooltip-help p-0 mb-1 ms-1"
                  style="border-color:transparent !important;"
                  data-bs-toggle="tooltip"
                  data-bs-html="true"
                  title='Please see <a href="https://github.com/oceanprotocol/algo_dockers" target="_blank">https://github.com/oceanprotocol/algo_dockers</a> for details about images.'
                >
                  {% icon 'help-circle' width="18px" height="18px" class="text-dark" %}
                </button>
              </label>
              <input
                id="input-docker_image"
                class="form-control form-control-sm serif"
                name="docker_image"
                type="text"
                spellcheck="false"
                value="oceanprotocol/algo_dockers"
              >
            </div>

            <!-- Docker Tag -->
            <div class="mt-3">
              <label
                for="input-docker_tag"
                class="form-label form-label-sm"
              >
                <small class="serif">Docker Tag</small>
              </label>
              <input
                id="input-docker_tag"
                class="form-control form-control-sm serif"
                name="docker_tag"
                type="text"
                spellcheck="false"
                value="python-panda"
              >
            </div>
          
            <!-- Data Assets -->
            <div class="mt-3">
              <label
                for="input-data_assets"
                class="form-label form-label-sm"
              >
                <small class="serif">Data Identification IDs (DIDs)</small>
                <button
                  type="button"
                  class="btn btn-tooltip-help p-0 mb-1 ms-1"
                  style="border-color:transparent !important;"
                  data-bs-toggle="tooltip"
                  data-bs-html="true"
                  title='You can view all data assets available for use on the <a href="https://cannlytics.com/data/market">Cannabis Data Market</a>.'
                >
                  {% icon 'help-circle' width="18px" height="18px" class="text-dark" %}
                </button>
              </label>
              <div class="row">
                <div class="col-10">
                  <input
                    type="text"
                    class="form-control form-control-sm serif"
                    id="input-did"
                    spellcheck="false"
                    name="did"
                  >
                </div>
                <button
                  class="btn btn-sm-light btn-md-light col-2"
                  type="button"
                  title="Add access to data asset."
                  onclick="addDataAsset();"
                >
                  {% icon "plus" width="16px" height="16px" %}
                </button>
              </div>
            </div>
            <div id="dids-container" class="d-flex flex-wrap"></div>
            <div id="did-template" class="d-none">
              <span class="did-text badge background-hover bg-transparent border border-dark d-flex align-items-center text-dark me-1 mt-2 py-0 pe-0"></span>
            </div>
            <button id="did-remove-template" class="d-none btn btn-sm nav-link ms-1" type="button">
              {% icon "x" width="16px" height="16px"%}
            </button>
            <input type="text" id="dids" class="visually-hidden" name="dids">

          </form><!-- End of Algorithm Detail Form  -->

        </div><!-- End of First Column -->

        <!-- Second Column | Python Code Editor -->
        <div class="col col-md-8">
          <label
            for="input-function-name"
            class="form-label form-label-sm mb-0 serif mt-3"
          >
            Algorithm
          </label>
          <div class="position-relative" style="height:520px;">
            <div class="highlight editor">
              <textarea
                id="editing"
                name="algorithm"
                placeholder=""
                spellcheck="false"
                oninput="update(this.value); sync_scroll(this);"
                onscroll="sync_scroll(this);"
                onkeydown="check_tab(this, event);"
              ></textarea>
              <pre id="highlighting" aria-hidden="true">
                <code id="highlighting-content" class="language-python p-0"></code>
              </pre>
            </div>
          </div>
        </div><!-- End of Second Column -->

        <!-- Publish -->
        <!-- TODO: Show "Preview" before "Publish" button -->
        <!-- TODO: Add checkbox for "I agree to the terms of service" / "View the terms of service" -->
        <div class="d-flex align-items-end mt-4">
          <button
            class="btn btn-sm bg-gradient-purple text-white serif"
            onclick="publishAlgorithm();"
          >
            Publish Algorithm
          </button>
        </div>

        <!-- Disclaimer -->
        
        <div class="mt-5">
          <h6 class="fw-bold mb-1 mt-3 serif">Notice</h6>
          <p class="fs-6 lh-md mt-0">
            <small class="serif">
              The Cannlytics Team maintains a purgatory list
              to block the listing of any algorithm that
              violates any policy.
            </small>
          </p>
          <h6 class="fw-bold mb-1 mt-3 serif">Disclaimer</h6>
          <p class="fs-6 lh-md mt-0">
            <small class="serif" style="font-size:0.7rem;">
            THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
            IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
            FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
            AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
            LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
            OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
            SOFTWARE.
            </small>
          </p>
        </div>
        

      </div>
    </div>
  </div><!-- End of Publish an Algorithm -->

  <!-- About -->
  <!-- TODO: Use introduction component and add an image? -->
  <div class="my-5">
    <h2 class="mb-2 text-dark serif">Need more information?</h2>
    <p class="fs-6 mt-0" style="max-width:540px;">
      The <a href="{% url "page" page="team" %}">
        Cannabis Data Science Team
      </a> and smart, talented people
      all around the world are chomping at the bits to write
      useful algorithms for you! Do you have any shortcomings at
      all with your current software system? Then these talented
      individuals can plug all of the holes in your current software
      with robust, peer-reviewed software at pennies
      on the dollar of the price of your traditional, closed-source developer.
      Please, take full advantage of the beautiful technology
      of open-source, smart contracts.
    </p>
    <div class="mt-3">
      <a
        class="btn btn-sm bg-gradient-orange text-white serif"
        href="{% url "page" page="contact" %}?topic=algorithms"
      >
        Get help now &rarr;
      </a>
    </div>
  </div>

</section>
{% include "website/components/art/vines.html" %}
{% endblock material %}
{% block page_css %}
  <link href="{% static 'website/css/prism.css'%}?{% if DEBUG %}{% now 'U' %}{% else %}{{ version }}{% endif %}" rel="stylesheet" />
  <link href="{% static 'website/css/prism-dracula.css'%}?{% if DEBUG %}{% now 'U' %}{% else %}{{ version }}{% endif %}" rel="stylesheet" />
  <link href="{% static 'website/css/farm.css'%}?{% if DEBUG %}{% now 'U' %}{% else %}{{ version }}{% endif %}" rel="stylesheet" />
{% endblock page_css %}
{% block page_js %}
  <script src="{% static 'website/js/prism.js'%}"></script>
  <script>
    
    // Initialize tooltips.
    cannlytics.ui.enableTooltips();

    // Initialize highlighting.
    // See: https://css-tricks.com/creating-an-editable-textarea-that-supports-syntax-highlighted-code/
    let result_element = document.querySelector("#highlighting-content");
    Prism.highlightElement(result_element);

    // Set an initial program into the code textarea.
    let code = `# External imports.
from cannlytics.data import Ocean
from cannlytics.stats import cultivar_prediction

def main(did):
    """
    Identify if a strain is a new cultivar.
    """

    # Connect to the data Ocean.
    ocean = Ocean()

    # Get the user's data.
    strain = ocean.assets.resolve(did)

    # Get your supplementary data.
    patents = ocean.assets.resolve(PATENT_DID)

    # Inform the user if the strain is a new cultivar.
    return cultivar_prediction(strain, patents)`;
    document.getElementById('editing').value = code;
    update(code);

    function update(text) {
      /**
       * Update the highlighted textarea text.
       */
      let result_element = document.querySelector("#highlighting-content");
      if(text[text.length-1] == "\n") text += "  ";
      result_element.innerHTML = text.replace(new RegExp("&", "g"), "&amp;").replace(new RegExp("<", "g"), "&lt;");
      Prism.highlightElement(result_element);
    }
    
    function sync_scroll(element) {
      /**
       * Scroll result to scroll coords of event - sync with textarea.
       */
      let result_element = document.querySelector('#highlighting');
      result_element.scrollTop = element.scrollTop;
      result_element.scrollLeft = element.scrollLeft;
    }
    
    function check_tab(element, event) {
      /**
       * Manage the textarea.
       */
      let code = element.value;
      if(event.key == 'Tab') {
        event.preventDefault();
        let before_tab = code.slice(0, element.selectionStart);
        let after_tab = code.slice(element.selectionEnd, element.value.length);
        let cursor_pos = element.selectionEnd + 1;
        element.value = before_tab + "\t" + after_tab;
        element.selectionStart = cursor_pos;
        element.selectionEnd = cursor_pos;
        update(element.value);
      }
    }

    function addDataAsset() {
      /**
       * Add a data asset to the algorithm form.
       */
      var input = document.getElementById('input-did');
      var value = input.value;
      var valuesInput = document.getElementById('dids');
      var values = valuesInput.value.split(',');
      if (values.includes(value)) return;
      var docFrag = document.createDocumentFragment();
      var tempNode = document.getElementById('did-template').cloneNode(true);
      var tempButton = document.getElementById('did-remove-template').cloneNode(true);
      tempButton.classList.remove('d-none');
      tempButton.id = `did-remove-${value}`;
      tempButton.onclick = function() { removeDataAsset(value); }
      tempNode.id = `did-${value}`;
      tempNode.classList.remove('d-none');
      tempNode.querySelector('.did-text').innerText = value;
      tempNode.querySelector('.did-text').appendChild(tempButton);
      docFrag.appendChild(tempNode);
      document.getElementById('dids-container').appendChild(docFrag);
      values.push(value);
      valuesInput.value = values.join(',');
      input.value = '';
    }

    function removeDataAsset(value) {
      /**
       * Remove a data asset to the algorithm form.
       */
      document.getElementById(`did-${value}`).remove();
      var valuesInput = document.getElementById('dids');
      var values = valuesInput.value.split(',');
      values = values.filter(function(item) { return item !== value; });
      valuesInput.value = values.join(',');
    }

    function publishAlgorithm() {
      /**
       * Publish an algorithm.
       */
      // Parse keywords.
      var didsInput = document.getElementById('dids');
      var dids = didsInput.value.split(',');
      dids = dids.filter(function(item) { return item !== ""; });

      // TODO: Publish the algorithm using the API to create an algorithm NFT.

      // Show a notification or ideally the published algorithm.
      cannlytics.utils.showNotification('Under Development', 'At this time, publishing algorithms is still under development. Please consider funding a small portion of our efforts or contributing on GitHub.', 'error', 7000);
    }

  </script>
{% endblock page_js %}
</html>
